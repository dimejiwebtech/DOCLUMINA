{% load static %}

<link href="{% static 'css/output.css' %}" rel="stylesheet" />
<link rel="stylesheet" href="{% static 'css/main.css' %}" />
<link
rel="stylesheet"
href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
/>

<div class="space-y-6">

  {% if needs_setup %}
    <div class="rounded-xl border border-yellow-200 bg-yellow-50 p-4">
      <div class="flex items-center justify-between gap-3">
        <div>
          <p class="font-semibold">Google Site Kit is not connected</p>
          <p class="text-sm text-gray-600">Connect to Google to pull Analytics, Search Console, and PageSpeed data.</p>
        </div>
        <a href="{% url 'google_sitekit:connect' %}" class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 transition-colors">Connect Now</a>
      </div>
    </div>
  {% else %}

  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-semibold">Site Kit Dashboard</h1>
      <p class="text-sm text-gray-600">Report window: {{ report_start }} → {{ report_end }}</p>
    </div>
    <div>
      <span class="inline-flex items-center rounded-full border border-gray-200 px-3 py-1 text-sm text-gray-700 bg-white">
        Target URL: <span class="ml-2 truncate w-64" title="{{ target_url }}">{{ target_url }}</span>
      </span>
    </div>
  </div>

  <!-- Overview Cards -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
    <div class="rounded-xl border border-gray-200 bg-white p-4 shadow-sm">
      <p class="text-sm text-gray-500">Sessions</p>
      <p class="mt-1 text-2xl font-semibold text-gray-900">{{ analytics_overview.sessions|default:0 }}</p>
    </div>
    <div class="rounded-xl border border-gray-200 bg-white p-4 shadow-sm">
      <p class="text-sm text-gray-500">Users</p>
      <p class="mt-1 text-2xl font-semibold text-gray-900">{{ analytics_overview.users|default:0 }}</p>
    </div>
    <div class="rounded-xl border border-gray-200 bg-white p-4 shadow-sm">
      <p class="text-sm text-gray-500">Pageviews</p>
      <p class="mt-1 text-2xl font-semibold text-gray-900">{{ analytics_overview.pageviews|default:0 }}</p>
    </div>
    <div class="rounded-xl border border-gray-200 bg-white p-4 shadow-sm">
      <p class="text-sm text-gray-500">Bounce Rate</p>
      <p class="mt-1 text-2xl font-semibold text-gray-900">{{ analytics_overview.bounce_rate|floatformat:1 }}%</p>
    </div>
  </div>

  <!-- Traffic Trend Chart (insert after Overview Cards) -->
<div class="rounded-xl border bg-white p-4 mt-4">
  <div class="flex items-center justify-between mb-3">
    <div>
      <p class="text-sm text-gray-500">Traffic (Sessions) — last 28 days</p>
      <p class="text-xs text-gray-400">Data source: Google Analytics (GA4)</p>
    </div>
  </div>

  <!-- Chart canvas -->
  <canvas id="trafficChart" class="w-full" height="120"></canvas>

  <!-- Pass data safely to JS using json_script which avoids XSS -->
  {{ traffic_series|default:{}|json_script:"traffic-series-data" }}
</div>

  <!-- Middle: Realtime + Traffic -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <div class="lg:col-span-1 rounded-xl border border-gray-200 bg-white shadow-sm">
      <div class="p-4 border-b border-gray-200">
        <p class="text-sm text-gray-500">Realtime</p>
        <p class="mt-1 text-2xl font-semibold text-gray-900"><span id="rt-count">{{ realtime_users|default:0 }}</span> active</p>
      </div>
      <div class="p-4 text-sm text-gray-600">
        Updates every 30 seconds.
      </div>
    </div>

    <div class="lg:col-span-2 rounded-xl border border-gray-200 bg-white shadow-sm">
      <div class="p-4 border-b border-gray-200">
        <p class="text-sm text-gray-500">Traffic Sources</p>
      </div>
      <div class="p-4">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
          {% for row in traffic_sources %}
          <div class="rounded-lg border border-gray-200 p-3">
            <p class="text-sm text-gray-500">{{ row.channel }}</p>
            <p class="text-xl font-semibold text-gray-900">{{ row.sessions }}</p>
          </div>
          {% empty %}
          <p class="text-sm text-gray-500">No traffic source data.</p>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom: Top Pages (Analytics) + Search Console (Queries/Pages) + PageSpeed -->
  <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
    <!-- Top pages (Analytics) -->
    <div class="rounded-xl border border-gray-200 bg-white shadow-sm overflow-hidden">
      <div class="p-4 border-b border-gray-200">
        <p class="text-sm text-gray-500">Top Pages (Analytics)</p>
      </div>
      <div class="p-4 overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left text-gray-500">
              <th class="py-2 pr-4 font-medium">Path</th>
              <th class="py-2 text-right font-medium">Views</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100">
            {% for p in top_pages %}
            <tr>
              <td class="py-2 pr-4 truncate w-80 text-gray-900">{{ p.path }}</td>
              <td class="py-2 text-right font-medium text-gray-900">{{ p.pageviews }}</td>
            </tr>
            {% empty %}
            <tr><td class="py-3 text-gray-500" colspan="2">No page data.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Search Console: Top Queries -->
    <div class="rounded-xl border border-gray-200 bg-white shadow-sm overflow-hidden">
      <div class="p-4 border-b border-gray-200">
        <p class="text-sm text-gray-500">Top Queries (Search Console)</p>
      </div>
      <div class="p-4 overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left text-gray-500">
              <th class="py-2 pr-4 font-medium">Query</th>
              <th class="py-2 text-right font-medium">Clicks</th>
              <th class="py-2 text-right font-medium">Impr.</th>
              <th class="py-2 text-right font-medium">CTR</th>
              <th class="py-2 text-right font-medium">Pos.</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100">
            {% for q in sc_queries %}
            <tr>
              <td class="py-2 pr-4 truncate w-64 text-gray-900">{{ q.query }}</td>
              <td class="py-2 text-right text-gray-900">{{ q.clicks }}</td>
              <td class="py-2 text-right text-gray-900">{{ q.impressions }}</td>
              <td class="py-2 text-right text-gray-900">{{ q.ctr|floatformat:1 }}%</td>
              <td class="py-2 text-right text-gray-900">{{ q.position|floatformat:1 }}</td>
            </tr>
            {% empty %}
            <tr><td class="py-3 text-gray-500" colspan="5">No query data.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- PageSpeed summary (mobile) + SC totals -->
    <div class="rounded-xl border border-gray-200 bg-white shadow-sm overflow-hidden">
      <div class="p-4 border-b border-gray-200">
        <p class="text-sm text-gray-500">PageSpeed (Mobile) & Search Totals</p>
      </div>
      <div class="p-4 space-y-4">
        {% if pagespeed_mobile %}
        <div class="rounded-lg border border-gray-200 p-3">
          <p class="text-sm text-gray-500 mb-2">Lighthouse Scores</p>
          <div class="grid grid-cols-2 gap-3 text-sm">
            <div><span class="text-gray-500">Performance</span><div class="font-semibold text-gray-900">{{ pagespeed_mobile.performance_score }}</div></div>
            <div><span class="text-gray-500">Accessibility</span><div class="font-semibold text-gray-900">{{ pagespeed_mobile.accessibility_score }}</div></div>
            <div><span class="text-gray-500">SEO</span><div class="font-semibold text-gray-900">{{ pagespeed_mobile.seo_score }}</div></div>
            <div><span class="text-gray-500">Best Practices</span><div class="font-semibold text-gray-900">{{ pagespeed_mobile.best_practices_score }}</div></div>
          </div>
          <div class="mt-3 grid grid-cols-2 gap-3 text-sm">
            <div><span class="text-gray-500">FCP (ms)</span><div class="font-semibold text-gray-900">{{ pagespeed_mobile.first_contentful_paint|floatformat:0 }}</div></div>
            <div><span class="text-gray-500">LCP (ms)</span><div class="font-semibold text-gray-900">{{ pagespeed_mobile.largest_contentful_paint|floatformat:0 }}</div></div>
            <div><span class="text-gray-500">FID (ms)</span><div class="font-semibold text-gray-900">{{ pagespeed_mobile.first_input_delay|floatformat:0 }}</div></div>
            <div><span class="text-gray-500">CLS</span><div class="font-semibold text-gray-900">{{ pagespeed_mobile.cumulative_layout_shift }}</div></div>
          </div>
        </div>
        {% else %}
        <p class="text-sm text-gray-500">PageSpeed data unavailable.</p>
        {% endif %}

        <div class="rounded-lg border border-gray-200 p-3">
          <p class="text-sm text-gray-500 mb-2">Search Console Totals</p>
          <div class="grid grid-cols-2 gap-3 text-sm">
            <div><span class="text-gray-500">Clicks</span><div class="font-semibold text-gray-900">{{ sc_totals.clicks }}</div></div>
            <div><span class="text-gray-500">Impressions</span><div class="font-semibold text-gray-900">{{ sc_totals.impressions }}</div></div>
            <div><span class="text-gray-500">CTR</span><div class="font-semibold text-gray-900">{{ sc_totals.ctr|floatformat:1 }}%</div></div>
            <div><span class="text-gray-500">Avg Position</span><div class="font-semibold text-gray-900">{{ sc_totals.position|floatformat:1 }}</div></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% endif %}
</div>

{% if is_connected %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script>
  // Refresh realtime users every 30s
  setInterval(() => {
    fetch("{% url 'google_sitekit:api_realtime' %}", {headers: {'X-Requested-With': 'XMLHttpRequest'}})
      .then(r => r.json())
      .then(d => {
        if (typeof d.active_users !== 'undefined') {
          const el = document.getElementById('rt-count');
          if (el) el.textContent = d.active_users;
        }
      }).catch(() => {});
  }, 30000);

  (function () {
    try {
      const raw = JSON.parse(document.getElementById('traffic-series-data').textContent || '{}');
      const labels = raw.labels || [];
      const values = raw.values || [];

      const ctx = document.getElementById('trafficChart').getContext('2d');

      // Destroy existing chart if present (useful in dev livereload)
      if (window._sitekitTrafficChart) {
        window._sitekitTrafficChart.destroy();
      }

      window._sitekitTrafficChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Sessions',
            data: values,
            fill: true,
            tension: 0.3,
            borderWidth: 2,
            pointRadius: 2,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              display: true,
              ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 10 }
            },
            y: {
              beginAtZero: true,
              ticks: { precision: 0 }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: { mode: 'index', intersect: false }
          }
        }
      });
    } catch (e) {
      // chart init failed — fail silently for development
      // You can view errors in the browser console
      console.warn('Traffic chart init error', e);
    }
  })();
</script>
{% endif %}